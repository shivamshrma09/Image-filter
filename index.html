<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Editor</title>
  <style>
    body { background: #f0f0f0; margin: 0; font-family: Roboto, Arial, sans-serif; }
    .dark-mode { background: #222; color: #eee; }
    #canvas, #beforeCanvas { border: 1px solid #999; display: block; margin: 20px auto; background: #222; }
    #beforeCanvas { display: none; }
    #slidingControls { position:fixed; bottom:0; left:0; right:0; background:#fff; box-shadow:0 -2px 10px #0003; transition:.3s; transform: translateY(100%); z-index:10; }
    #slidingControls.active { transform: translateY(0); }
    #snackbar { visibility: hidden; min-width: 180px; background: #333; color: #fff; text-align: center; border-radius: 2px; padding: 10px 20px; position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); z-index: 99; }
    #snackbar.show { visibility: visible; animation: fadein .3s, fadeout .3s 1.3s; }
    @keyframes fadein { from{bottom:0;opacity:0} to{bottom:30px;opacity:1} }
    @keyframes fadeout { from{bottom:30px;opacity:1} to{bottom:0;opacity:0} }
    .toolbar-btn { margin: 0 6px; }
  </style>
</head>
<body>
  <input type="file" id="fileInput" accept="image/*" style="margin:20px;">
  <button class="toolbar-btn" onclick="rotateImage()">Rotate</button>
  <button class="toolbar-btn" onclick="flipImage('h')">Flip H</button>
  <button class="toolbar-btn" onclick="flipImage('v')">Flip V</button>
  <button class="toolbar-btn" onclick="addText()">Add Text</button>
  <button class="toolbar-btn" onclick="undo()">Undo</button>
  <button class="toolbar-btn" onclick="redo()">Redo</button>
  <button class="toolbar-btn" onclick="resetImage()">Reset</button>
  <button class="toolbar-btn" onclick="showBeforeAfter()">Before/After</button>
  <button class="toolbar-btn" onclick="preset('brighten')">Brighten</button>
  <button class="toolbar-btn" onclick="preset('bw')">B/W</button>
  <button class="toolbar-btn" onclick="preset('funky')">Funky</button>
  <button class="toolbar-btn" onclick="preset('vintage')">Vintage</button>
  <button class="toolbar-btn" onclick="downloadImage('png')">Download PNG</button>
  <button class="toolbar-btn" id="toggleMode">Dark/Light</button>
  <button class="toolbar-btn" onclick="toggleSlidingControls()">Filters</button>
  <canvas id="canvas" width="600" height="400"></canvas>
  <canvas id="beforeCanvas" width="600" height="400"></canvas>
  <div id="slidingControls">
    <div style="padding:10px;">
      <label>Brightness <input type="range" id="brightness" min="0" max="200" value="100" oninput="applyFilter()"><span id="brightnessVal">100</span></label><br>
      <label>Contrast <input type="range" id="contrast" min="0" max="200" value="100" oninput="applyFilter()"><span id="contrastVal">100</span></label><br>
      <label>Grayscale <input type="range" id="grayscale" min="0" max="100" value="0" oninput="applyFilter()"><span id="grayscaleVal">0</span></label><br>
      <label>Saturate <input type="range" id="saturate" min="0" max="300" value="100" oninput="applyFilter()"><span id="saturateVal">100</span></label><br>
      <label>Sepia <input type="range" id="sepia" min="0" max="200" value="0" oninput="applyFilter()"><span id="sepiaVal">0</span></label><br>
      <label>Hue <input type="range" id="hue" min="0" max="360" value="0" oninput="applyFilter()"><span id="hueVal">0</span></label><br>
      <label>Blur <input type="range" id="blur" min="0" max="10" value="0" oninput="applyFilter()"><span id="blurVal">0</span></label><br>
      <label>Invert <input type="range" id="invert" min="0" max="100" value="0" oninput="applyFilter()"><span id="invertVal">0</span></label><br>
      <label>Opacity <input type="range" id="opacity" min="0" max="100" value="100" oninput="applyFilter()"><span id="opacityVal">100</span></label>
    </div>
  </div>
  <div id="snackbar"></div>
<script>
  let canvas = document.getElementById('canvas');
  let ctx = canvas.getContext('2d');
  let beforeCanvas = document.getElementById('beforeCanvas');
  let beforeCtx = beforeCanvas.getContext('2d');
  let img = new Image();
  let imgLoaded = false;
  let imgDataURL = "";
  let history = [];
  let redoStack = [];
  let rotation = 0;
  let flipH = false, flipV = false;
  let textElements = [];
  let darkMode = false;
  const slidingControls = document.getElementById('slidingControls');
  const filterIds = ["brightness","contrast","grayscale","saturate","sepia","hue","blur","invert","opacity"];
  const filterDefaults = {
    brightness:100, contrast:100, grayscale:0, saturate:100, sepia:0,
    hue:0, blur:0, invert:0, opacity:100
  };
  let currentFilterState = {};
  function init() {
    filterIds.forEach(id => {
      document.getElementById(id).value = filterDefaults[id];
      document.getElementById(id + "Val").innerText = filterDefaults[id];
      currentFilterState[id] = filterDefaults[id];
    });
    rotation = 0;
    flipH = false;
    flipV = false;
    textElements = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    saveHistory();
  }
  document.getElementById('fileInput').onchange = uploadImage;
  function uploadImage(e) {
    const file = e.target.files ? e.target.files[0] : e.dataTransfer.files[0];
    if (!file || !file.type.startsWith("image/")) {
      showSnackbar("Please select an image file!");
      return;
    }
    const reader = new FileReader();
    reader.onload = function(ev) {
      img.onload = function() {
        const maxWidth = window.innerWidth * 0.9;
        const maxHeight = window.innerHeight * 0.7;
        let newWidth = img.width, newHeight = img.height;
        if (newWidth > maxWidth) {
          newHeight = newHeight * (maxWidth / newWidth);
          newWidth = maxWidth;
        }
        if (newHeight > maxHeight) {
          newWidth = newWidth * (maxHeight / newHeight);
          newHeight = maxHeight;
        }
        canvas.width = beforeCanvas.width = newWidth;
        canvas.height = beforeCanvas.height = newHeight;
        imgLoaded = true;
        imgDataURL = ev.target.result;
        init();
        applyFilter();
        showSnackbar("Image loaded successfully!");
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }
  function applyFilter() {
    if (!imgLoaded) return;
    filterIds.forEach(id => {
      const value = parseFloat(document.getElementById(id).value);
      document.getElementById(id + "Val").innerText = value;
      currentFilterState[id] = value;
    });
    const filterStr =
      `brightness(${currentFilterState.brightness}%) ` +
      `contrast(${currentFilterState.contrast}%) ` +
      `grayscale(${currentFilterState.grayscale}%) ` +
      `saturate(${currentFilterState.saturate}%) ` +
      `sepia(${currentFilterState.sepia}%) ` +
      `hue-rotate(${currentFilterState.hue}deg) ` +
      `blur(${currentFilterState.blur}px) ` +
      `invert(${currentFilterState.invert}%) ` +
      `opacity(${currentFilterState.opacity}%)`;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.filter = filterStr;
    drawTransformedElements();
    ctx.filter = 'none';
    saveHistory();
  }
  function drawTransformedElements() {
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(flipH ? -1 : 1, flipV ? -1 : 1);
    ctx.rotate(rotation * Math.PI / 180);
    ctx.drawImage(img, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
    ctx.restore();
    textElements.forEach(textObj => {
      ctx.save();
      ctx.font = `${textObj.size}px ${textObj.font}`;
      ctx.fillStyle = textObj.color;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.translate(textObj.x, textObj.y);
      ctx.rotate(textObj.rotation * Math.PI / 180);
      ctx.fillText(textObj.text, 0, 0);
      ctx.restore();
    });
  }
  function preset(type) {
    resetFilters();
    if (type === "brighten") {
      document.getElementById('brightness').value = 140;
      document.getElementById('contrast').value = 120;
      document.getElementById('saturate').value = 120;
    } else if (type === "bw") {
      document.getElementById('grayscale').value = 100;
      document.getElementById('brightness').value = 120;
      document.getElementById('contrast').value = 120;
    } else if (type === "funky") {
      document.getElementById('hue').value = Math.floor(Math.random() * 360);
      document.getElementById('contrast').value = 120;
      document.getElementById('saturate').value = 150;
    } else if (type === "vintage") {
      document.getElementById('brightness').value = 120;
      document.getElementById('saturate').value = 120;
      document.getElementById('sepia').value = 150;
    }
    applyFilter();
    showSnackbar(`${type.charAt(0).toUpperCase() + type.slice(1)} preset applied!`);
  }
  function resetFilters() {
    filterIds.forEach(id => {
      document.getElementById(id).value = filterDefaults[id];
      document.getElementById(id + "Val").innerText = filterDefaults[id];
    });
  }
  function resetImage() {
    if (!imgLoaded) {
      showSnackbar("No image to reset!");
      return;
    }
    img.onload = function() {
      imgLoaded = true;
      init();
      applyFilter();
      showSnackbar("Image reset to original!");
    };
    img.src = imgDataURL;
  }
  function saveHistory() {
    if (!imgLoaded) return;
    const currentState = {
      filters: { ...currentFilterState },
      rotation: rotation,
      flipH: flipH,
      flipV: flipV,
      textElements: JSON.parse(JSON.stringify(textElements)),
    };
    const lastState = history[history.length - 1];
    if (lastState && JSON.stringify(lastState) === JSON.stringify(currentState)) return;
    history.push(currentState);
    if (history.length > 30) history.shift();
    redoStack = [];
  }
  function restoreState(state) {
    filterIds.forEach(id => {
      document.getElementById(id).value = state.filters[id];
      document.getElementById(id + "Val").innerText = state.filters[id];
    });
    currentFilterState = { ...state.filters };
    rotation = state.rotation;
    flipH = state.flipH;
    flipV = state.flipV;
    textElements = state.textElements ? JSON.parse(JSON.stringify(state.textElements)) : [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.filter =
      `brightness(${currentFilterState.brightness}%) ` +
      `contrast(${currentFilterState.contrast}%) ` +
      `grayscale(${currentFilterState.grayscale}%) ` +
      `saturate(${currentFilterState.saturate}%) ` +
      `sepia(${currentFilterState.sepia}%) ` +
      `hue-rotate(${currentFilterState.hue}deg) ` +
      `blur(${currentFilterState.blur}px) ` +
      `invert(${currentFilterState.invert}%) ` +
      `opacity(${currentFilterState.opacity}%)`;
    drawTransformedElements();
    ctx.filter = 'none';
  }
  function undo() {
    if (history.length < 2) {
      showSnackbar("Nothing to undo!");
      return;
    }
    const currentState = history.pop();
    redoStack.push(currentState);
    const prevState = history[history.length - 1];
    restoreState(prevState);
    showSnackbar("Undo successful!");
  }
  function redo() {
    if (redoStack.length === 0) {
      showSnackbar("Nothing to redo!");
      return;
    }
    const nextState = redoStack.pop();
    history.push(nextState);
    restoreState(nextState);
    showSnackbar("Redo successful!");
  }
  function rotateImage() {
    if (!imgLoaded) {
      showSnackbar("Please load an image first!");
      return;
    }
    if (rotation % 180 === 0) {
      [canvas.width, canvas.height] = [canvas.height, canvas.width];
      [beforeCanvas.width, beforeCanvas.height] = [beforeCanvas.height, beforeCanvas.width];
    }
    rotation = (rotation + 90) % 360;
    applyFilter();
    showSnackbar("Image rotated!");
  }
  function flipImage(dir) {
    if (!imgLoaded) {
      showSnackbar("Please load an image first!");
      return;
    }
    if (dir === 'h') flipH = !flipH;
    if (dir === 'v') flipV = !flipV;
    applyFilter();
    showSnackbar(`Image flipped ${dir === 'h' ? 'horizontally' : 'vertically'}!`);
  }
  function showBeforeAfter() {
    if (!imgLoaded) {
      showSnackbar("No image to compare!");
      return;
    }
    beforeCtx.clearRect(0, 0, beforeCanvas.width, beforeCanvas.height);
    beforeCtx.drawImage(img, 0, 0, beforeCanvas.width, beforeCanvas.height);
    beforeCanvas.style.display = "block";
    canvas.style.display = "none";
    showSnackbar("Showing original image...");
    setTimeout(() => {
      beforeCanvas.style.display = "none";
      canvas.style.display = "block";
    }, 1800);
  }
  function downloadImage(format) {
    if (!imgLoaded) {
      showSnackbar("No image to download!");
      return;
    }
    const dataURL = canvas.toDataURL(`image/${format}`, 1.0);
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `edited_image.${format}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showSnackbar(`Downloaded as ${format.toUpperCase()}!`);
  }
  document.getElementById('toggleMode').onclick = function() {
    darkMode = !darkMode;
    document.body.classList.toggle('dark-mode', darkMode);
    showSnackbar(darkMode ? "Dark mode activated!" : "Light mode activated!");
  }
  function showSnackbar(msg) {
    let sb = document.getElementById('snackbar');
    sb.innerText = msg;
    sb.classList.add('show');
    setTimeout(() => sb.classList.remove('show'), 1600);
  }
  function addText() {
    if (!imgLoaded) {
      showSnackbar("Please load an image first to add text!");
      return;
    }
    const textInput = prompt("Enter your text:", "Hello InShot!");
    if (textInput !== null && textInput.trim() !== "") {
      const newText = {
        text: textInput,
        x: canvas.width / 2,
        y: canvas.height / 2,
        font: "Roboto",
        size: 40,
        color: "#FFFFFF",
        rotation: 0,
      };
      textElements.push(newText);
      applyFilter();
      showSnackbar("Text added!");
    } else {
      showSnackbar("Text addition cancelled or empty!");
    }
  }
  canvas.addEventListener('dblclick', function(e) {
    if (!imgLoaded) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    let found = false;
    textElements.forEach((text, i) => {
      if (Math.abs(x - text.x) < 60 && Math.abs(y - text.y) < 30) {
        const newText = prompt("Edit text:", text.text);
        if (newText !== null && newText.trim() !== "") {
          textElements[i].text = newText;
          applyFilter();
          found = true;
        }
      }
    });
    if (found) showSnackbar("Text edited!");
  });
  function toggleSlidingControls() {
    slidingControls.classList.toggle('active');
  }
  document.addEventListener('click', function(event) {
    if (slidingControls.classList.contains('active') &&
        !slidingControls.contains(event.target) &&
        !event.target.closest('.toolbar-btn')) {
      toggleSlidingControls();
    }
  });
  slidingControls.addEventListener('touchmove', (e) => {
    e.stopPropagation();
  }, false);
  canvas.oncontextmenu = (e) => {
    e.preventDefault();
    return false;
  };
  window.addEventListener('resize', () => {
    if(imgLoaded) {
      const maxWidth = window.innerWidth * 0.9;
      const maxHeight = window.innerHeight * 0.7;
      let newWidth = img.width, newHeight = img.height;
      if (newWidth > maxWidth) {
        newHeight = newHeight * (maxWidth / newWidth);
        newWidth = maxWidth;
      }
      if (newHeight > maxHeight) {
        newWidth = newWidth * (maxHeight / newHeight);
        newHeight = maxHeight;
      }
      canvas.width = beforeCanvas.width = newWidth;
      canvas.height = beforeCanvas.height = newHeight;
      applyFilter();
    }
  });
  init();
</script>
</body>
</html>
